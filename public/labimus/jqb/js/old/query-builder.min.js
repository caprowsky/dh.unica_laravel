/*!
 * jQuery QueryBuilder 2.4.0
 * Copyright 2014-2018 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */

function Model(a){return this instanceof Model?(this.root=null,void(this.$=$(this))):Model.getModel(a)}function determineMongoOperator(a,b){if(null!==a&&"object"==typeof a){var c=Object.keys(a);return 1===c.length?c[0]:void 0!==a.$gte&&void 0!==a.$lte?"between":void 0!==a.$lt&&void 0!==a.$gt?"not_between":void 0!==a.$regex?"$regex":void 0}return"eq"}function andOr(a){for(var b=Object.keys(a),c=0,d=b.length;c<d;c++)if("$or"==b[c].toLowerCase()||"$and"==b[c].toLowerCase())return b[c]}function moveSortableToTarget(a,b){var c;return c=b.closest(Selectors.rule_container),c.length?void a.moveAfter(Model(c)):(c=b.closest(Selectors.group_header),c.length?(c=b.closest(Selectors.group_container),void a.moveAtBegin(Model(c))):(c=b.closest(Selectors.group_container),c.length?void a.moveAtEnd(Model(c)):void 0))}function getStmtConfig(a){var b=a.match(/(question_mark|numbered|named)(?:\((.)\))?/);return b||(b=[null,"question_mark",void 0]),b}var QueryBuilder=function(a,b){this.init(a,b)};$.extend(QueryBuilder.prototype,{change:function(a,b){var c=new $.Event(this.tojQueryEvent(a,!0),{builder:this,value:b});return this.$el.triggerHandler(c,Array.prototype.slice.call(arguments,2)),c.value},trigger:function(a){var b=new $.Event(this.tojQueryEvent(a),{builder:this});return this.$el.triggerHandler(b,Array.prototype.slice.call(arguments,1)),b},on:function(a,b){return this.$el.on(this.tojQueryEvent(a),b),this},off:function(a,b){return this.$el.off(this.tojQueryEvent(a),b),this},once:function(a,b){return this.$el.one(this.tojQueryEvent(a),b),this},tojQueryEvent:function(a,b){return a.split(" ").map(function(a){return a+".queryBuilder"+(b?".filter":"")}).join(" ")}}),QueryBuilder.plugins={},QueryBuilder.defaults=function(a){return"object"!=typeof a?"string"==typeof a?"object"==typeof QueryBuilder.DEFAULTS[a]?$.extend(!0,{},QueryBuilder.DEFAULTS[a]):QueryBuilder.DEFAULTS[a]:$.extend(!0,{},QueryBuilder.DEFAULTS):void $.extendext(!0,"replace",QueryBuilder.DEFAULTS,a)},QueryBuilder.define=function(a,b,c){QueryBuilder.plugins[a]={fct:b,def:c||{}}},QueryBuilder.extend=function(a){$.extend(QueryBuilder.prototype,a)},QueryBuilder.prototype.initPlugins=function(){if(this.plugins){if($.isArray(this.plugins)){var a={};this.plugins.forEach(function(b){a[b]=null}),this.plugins=a}Object.keys(this.plugins).forEach(function(a){a in QueryBuilder.plugins?(this.plugins[a]=$.extend(!0,{},QueryBuilder.plugins[a].def,this.plugins[a]||{}),QueryBuilder.plugins[a].fct.call(this,this.plugins[a])):Utils.error("Config",'Unable to find plugin "{0}"',a)},this)}},QueryBuilder.types={string:"string",integer:"number","double":"number",date:"datetime",time:"datetime",datetime:"datetime","boolean":"boolean"},QueryBuilder.inputs=["text","textarea","radio","checkbox","select"],QueryBuilder.modifiable_options=["display_errors","allow_groups","allow_empty","default_condition","default_filter"];var Selectors=QueryBuilder.selectors={group_container:".rules-group-container",rule_container:".rule-container",filter_container:".rule-filter-container",operator_container:".rule-operator-container",value_container:".rule-value-container",error_container:".error-container",condition_container:".rules-group-header .group-conditions",rule_header:".rule-header",group_header:".rules-group-header",group_actions:".group-actions",rule_actions:".rule-actions",rules_list:".rules-group-body>.rules-list",group_condition:".rules-group-header [name$=_cond]",rule_filter:".rule-filter-container [name$=_filter]",rule_operator:".rule-operator-container [name$=_operator]",rule_value:".rule-value-container [name*=_value_]",add_rule:"[data-add=rule]",delete_rule:"[data-delete=rule]",add_group:"[data-add=group]",delete_group:"[data-delete=group]"};QueryBuilder.templates={},QueryBuilder.regional={},QueryBuilder.OPERATORS={equal:{type:"equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},not_equal:{type:"not_equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},"in":{type:"in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},not_in:{type:"not_in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},less:{type:"less",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},less_or_equal:{type:"less_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater:{type:"greater",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater_or_equal:{type:"greater_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},between:{type:"between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},not_between:{type:"not_between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},begins_with:{type:"begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_begins_with:{type:"not_begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},contains:{type:"contains",nb_inputs:1,multiple:!1,apply_to:["string"]},not_contains:{type:"not_contains",nb_inputs:1,multiple:!1,apply_to:["string"]},ends_with:{type:"ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_ends_with:{type:"not_ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},is_empty:{type:"is_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_not_empty:{type:"is_not_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_null:{type:"is_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]},is_not_null:{type:"is_not_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]}},QueryBuilder.DEFAULTS={filters:[],plugins:[],sort_filters:!1,display_errors:!0,allow_groups:-1,allow_empty:!1,conditions:["AND","OR"],default_condition:"AND",inputs_separator:" , ",select_placeholder:"------",display_empty_filter:!0,default_filter:null,optgroups:{},default_rule_flags:{filter_readonly:!1,operator_readonly:!1,value_readonly:!1,no_delete:!1},default_group_flags:{condition_readonly:!1,no_add_rule:!1,no_add_group:!1,no_delete:!1},templates:{group:null,rule:null,filterSelect:null,operatorSelect:null},lang_code:"en",lang:{},operators:["equal","not_equal","in","not_in","less","less_or_equal","greater","greater_or_equal","between","not_between","begins_with","not_begins_with","contains","not_contains","ends_with","not_ends_with","is_empty","is_not_empty","is_null","is_not_null"],icons:{add_group:"glyphicon glyphicon-plus-sign",add_rule:"glyphicon glyphicon-plus",remove_group:"glyphicon glyphicon-remove",remove_rule:"glyphicon glyphicon-remove",error:"glyphicon glyphicon-warning-sign"}},QueryBuilder.prototype.init=function(a,b){a[0].queryBuilder=this,this.$el=a,this.settings=$.extendext(!0,"replace",{},QueryBuilder.DEFAULTS,b),this.model=new Model,this.status={group_id:0,rule_id:0,generated_id:!1,has_optgroup:!1,has_operator_oprgroup:!1,id:null,updating_value:!1},this.settings.allow_groups===!1?this.settings.allow_groups=0:this.settings.allow_groups===!0&&(this.settings.allow_groups=-1),this.filters=this.settings.filters,this.icons=this.settings.icons,this.operators=this.settings.operators,this.templates=this.settings.templates,this.plugins=this.settings.plugins,void 0===QueryBuilder.regional.en&&Utils.error("Config",'"i18n/en.js" not loaded.'),this.lang=$.extendext(!0,"replace",{},QueryBuilder.regional.en,QueryBuilder.regional[this.settings.lang_code],this.settings.lang),Object.keys(this.templates).forEach(function(a){this.templates[a]||(this.templates[a]=QueryBuilder.templates[a]),"string"==typeof this.templates[a]&&(this.templates[a]=doT.template(this.templates[a]))},this),this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generated_id=!0),this.status.id=this.$el.attr("id"),this.$el.addClass("query-builder form-inline"),this.filters=this.checkFilters(this.filters),this.operators=this.checkOperators(this.operators),this.bindEvents(),this.initPlugins(),this.trigger("afterInit"),b.rules?(this.setRules(b.rules),delete this.settings.rules):this.setRoot(!0)},QueryBuilder.prototype.checkFilters=function(a){var b=[];if(a&&0!==a.length||Utils.error("Config","Missing filters list"),a.forEach(function(a,c){switch(a.id||Utils.error("Config","Missing filter {0} id",c),b.indexOf(a.id)!=-1&&Utils.error("Config",'Filter "{0}" already defined',a.id),b.push(a.id),a.type?QueryBuilder.types[a.type]||Utils.error("Config",'Invalid type "{0}"',a.type):a.type="string",a.input?"function"!=typeof a.input&&QueryBuilder.inputs.indexOf(a.input)==-1&&Utils.error("Config",'Invalid input "{0}"',a.input):a.input="text",a.operators&&a.operators.forEach(function(a){"string"!=typeof a&&Utils.error("Config","Filter operators must be global operators types (string)")}),a.field||(a.field=a.id),a.label||(a.label=a.field),a.optgroup?(this.status.has_optgroup=!0,this.settings.optgroups[a.optgroup]||(this.settings.optgroups[a.optgroup]=a.optgroup)):a.optgroup=null,a.input){case"radio":case"checkbox":(!a.values||a.values.length<1)&&Utils.error("Config",'Missing filter "{0}" values',a.id);break;case"select":a.placeholder&&(void 0===a.placeholder_value&&(a.placeholder_value=-1),Utils.iterateOptions(a.values,function(b){b==a.placeholder_value&&Utils.error("Config",'Placeholder of filter "{0}" overlaps with one of its values',a.id)}))}},this),this.settings.sort_filters)if("function"==typeof this.settings.sort_filters)a.sort(this.settings.sort_filters);else{var c=this;a.sort(function(a,b){return c.translateLabel(a.label).localeCompare(c.translateLabel(b.label))})}return this.status.has_optgroup&&(a=Utils.groupSort(a,"optgroup")),a},QueryBuilder.prototype.checkOperators=function(a){var b=[];return a.forEach(function(c,d){"string"==typeof c?(QueryBuilder.OPERATORS[c]||Utils.error("Config",'Unknown operator "{0}"',c),a[d]=c=$.extendext(!0,"replace",{},QueryBuilder.OPERATORS[c])):(c.type||Utils.error("Config",'Missing "type" for operator {0}',d),QueryBuilder.OPERATORS[c.type]&&(a[d]=c=$.extendext(!0,"replace",{},QueryBuilder.OPERATORS[c.type],c)),void 0!==c.nb_inputs&&void 0!==c.apply_to||Utils.error("Config",'Missing "nb_inputs" and/or "apply_to" for operator "{0}"',c.type)),b.indexOf(c.type)!=-1&&Utils.error("Config",'Operator "{0}" already defined',c.type),b.push(c.type),c.optgroup?(this.status.has_operator_optgroup=!0,this.settings.optgroups[c.optgroup]||(this.settings.optgroups[c.optgroup]=c.optgroup)):c.optgroup=null},this),this.status.has_operator_optgroup&&(a=Utils.groupSort(a,"optgroup")),a},QueryBuilder.prototype.bindEvents=function(){var a=this;this.$el.on("change.queryBuilder",Selectors.group_condition,function(a){if($(this).is(":checked")){var b=$(this).closest(Selectors.group_container);Model(b).condition=$(this).val()}a.stopPropagation()}),this.$el.on("change.queryBuilder",Selectors.rule_filter,function(b){var c=$(this).closest(Selectors.rule_container);Model(c).filter=a.getFilterById($(this).val()),b.stopPropagation()}),this.$el.on("change.queryBuilder",Selectors.rule_operator,function(b){var c=$(this).closest(Selectors.rule_container);Model(c).operator=a.getOperatorByType($(this).val()),b.stopPropagation()}),this.$el.on("click.queryBuilder",Selectors.add_rule,function(b){var c=$(this).closest(Selectors.group_container);a.addRule(Model(c)),b.stopPropagation()}),this.$el.on("click.queryBuilder",Selectors.delete_rule,function(b){var c=$(this).closest(Selectors.rule_container);a.deleteRule(Model(c)),b.stopPropagation()}),0!==this.settings.allow_groups&&(this.$el.on("click.queryBuilder",Selectors.add_group,function(b){var c=$(this).closest(Selectors.group_container);a.addGroup(Model(c)),b.stopPropagation()}),this.$el.on("click.queryBuilder",Selectors.delete_group,function(b){var c=$(this).closest(Selectors.group_container);a.deleteGroup(Model(c)),b.stopPropagation()})),this.model.on({drop:function(b,c){c.$el.remove(),a.refreshGroupsConditions()},add:function(b,c,d){0===d?c.$el.prependTo(c.parent.$el.find(">"+Selectors.rules_list)):c.$el.insertAfter(c.parent.rules[d-1].$el),a.refreshGroupsConditions()},move:function(b,c,d,e){c.$el.detach(),0===e?c.$el.prependTo(d.$el.find(">"+Selectors.rules_list)):c.$el.insertAfter(d.rules[e-1].$el),a.refreshGroupsConditions()},update:function(b,c,d,e,f){if(c instanceof Rule)switch(d){case"error":a.displayError(c);break;case"flags":a.applyRuleFlags(c);break;case"filter":a.updateRuleFilter(c,f);break;case"operator":a.updateRuleOperator(c,f);break;case"value":a.updateRuleValue(c)}else switch(d){case"error":a.displayError(c);break;case"flags":a.applyGroupFlags(c);break;case"condition":a.updateGroupCondition(c)}}})},QueryBuilder.prototype.setRoot=function(a,b,c){a=void 0===a||a===!0;var d=this.nextGroupId(),e=$(this.getGroupTemplate(d,1));return this.$el.append(e),this.model.root=new Group(null,e),this.model.root.model=this.model,this.model.root.data=b,this.model.root.flags=$.extend({},this.settings.default_group_flags,c),this.trigger("afterAddGroup",this.model.root),this.model.root.condition=this.settings.default_condition,a&&this.addRule(this.model.root),this.model.root},QueryBuilder.prototype.addGroup=function(a,b,c,d){b=void 0===b||b===!0;var e=a.level+1,f=this.trigger("beforeAddGroup",a,b,e);if(f.isDefaultPrevented())return null;var g=this.nextGroupId(),h=$(this.getGroupTemplate(g,e)),i=a.addGroup(h);return i.data=c,i.flags=$.extend({},this.settings.default_group_flags,d),this.trigger("afterAddGroup",i),i.condition=this.settings.default_condition,b&&this.addRule(i),i},QueryBuilder.prototype.deleteGroup=function(a){if(a.isRoot())return!1;var b=this.trigger("beforeDeleteGroup",a);if(b.isDefaultPrevented())return!1;var c=!0;return a.each("reverse",function(a){c&=this.deleteRule(a)},function(a){c&=this.deleteGroup(a)},this),c&&(a.drop(),this.trigger("afterDeleteGroup")),c},QueryBuilder.prototype.updateGroupCondition=function(a){a.$el.find(">"+Selectors.group_condition).each(function(){var b=$(this);b.prop("checked",b.val()===a.condition),b.parent().toggleClass("active",b.val()===a.condition)}),this.trigger("afterUpdateGroupCondition",a)},QueryBuilder.prototype.refreshGroupsConditions=function(){!function a(b){(!b.flags||b.flags&&!b.flags.condition_readonly)&&b.$el.find(">"+Selectors.group_condition).prop("disabled",b.rules.length<=1).parent().toggleClass("disabled",b.rules.length<=1),b.each(function(a){},function(b){a(b)},this)}(this.model.root)},QueryBuilder.prototype.addRule=function(a,b,c){var d=this.trigger("beforeAddRule",a);if(d.isDefaultPrevented())return null;var e=this.nextRuleId(),f=$(this.getRuleTemplate(e)),g=a.addRule(f);return void 0!==b&&(g.data=b),g.flags=$.extend({},this.settings.default_rule_flags,c),this.trigger("afterAddRule",g),this.createRuleFilters(g),!this.settings.default_filter&&this.settings.display_empty_filter||(g.filter=this.change("getDefaultFilter",this.getFilterById(this.settings.default_filter||this.filters[0].id),g)),g},QueryBuilder.prototype.deleteRule=function(a){if(a.flags.no_delete)return!1;var b=this.trigger("beforeDeleteRule",a);return!b.isDefaultPrevented()&&(a.drop(),this.trigger("afterDeleteRule"),!0)},QueryBuilder.prototype.createRuleFilters=function(a){var b=this.change("getRuleFilters",this.filters,a),c=$(this.getRuleFilterSelect(a,b));a.$el.find(Selectors.filter_container).html(c),this.trigger("afterCreateRuleFilters",a)},QueryBuilder.prototype.createRuleOperators=function(a){var b=a.$el.find(Selectors.operator_container).empty();if(a.filter){var c=this.getOperators(a.filter),d=$(this.getRuleOperatorSelect(a,c));b.html(d),a.__.operator=c[0],this.trigger("afterCreateRuleOperators",a,c)}},QueryBuilder.prototype.createRuleInput=function(a){var b=a.$el.find(Selectors.value_container).empty();if(a.__.value=void 0,a.filter&&a.operator&&0!==a.operator.nb_inputs){for(var c=this,d=$(),e=a.filter,f=0;f<a.operator.nb_inputs;f++){var g=$(this.getRuleInput(a,f));f>0&&b.append(this.settings.inputs_separator),b.append(g),d=d.add(g)}b.show(),d.on("change "+(e.input_event||""),function(){c.status.updating_value=!0,a.value=c.getRuleValue(a),c.status.updating_value=!1}),e.plugin&&d[e.plugin](e.plugin_config||{}),this.trigger("afterCreateRuleInput",a),void 0!==e.default_value?a.value=e.default_value:(c.status.updating_value=!0,a.value=c.getRuleValue(a),c.status.updating_value=!1)}},QueryBuilder.prototype.updateRuleFilter=function(a,b){this.createRuleOperators(a),this.createRuleInput(a),a.$el.find(Selectors.rule_filter).val(a.filter?a.filter.id:"-1"),b&&a.filter&&b.id!==a.filter.id&&(a.data=void 0),this.trigger("afterUpdateRuleFilter",a)},QueryBuilder.prototype.updateRuleOperator=function(a,b){var c=a.$el.find(Selectors.value_container);a.operator&&0!==a.operator.nb_inputs?(c.show(),(c.is(":empty")||a.operator.nb_inputs!==b.nb_inputs)&&this.createRuleInput(a)):(c.hide(),a.__.value=void 0),a.operator&&a.$el.find(Selectors.rule_operator).val(a.operator.type),this.trigger("afterUpdateRuleOperator",a),this.updateRuleValue(a)},QueryBuilder.prototype.updateRuleValue=function(a){this.status.updating_value||this.setRuleValue(a,a.value),this.trigger("afterUpdateRuleValue",a)},QueryBuilder.prototype.applyRuleFlags=function(a){var b=a.flags;b.filter_readonly&&a.$el.find(Selectors.rule_filter).prop("disabled",!0),b.operator_readonly&&a.$el.find(Selectors.rule_operator).prop("disabled",!0),b.value_readonly&&a.$el.find(Selectors.rule_value).prop("disabled",!0),b.no_delete&&a.$el.find(Selectors.delete_rule).remove(),this.trigger("afterApplyRuleFlags",a)},QueryBuilder.prototype.applyGroupFlags=function(a){var b=a.flags;b.condition_readonly&&a.$el.find(">"+Selectors.group_condition).prop("disabled",!0).parent().addClass("readonly"),b.no_add_rule&&a.$el.find(Selectors.add_rule).remove(),b.no_add_group&&a.$el.find(Selectors.add_group).remove(),b.no_delete&&a.$el.find(Selectors.delete_group).remove(),this.trigger("afterApplyGroupFlags",a)},QueryBuilder.prototype.clearErrors=function(a){a=a||this.model.root,a&&(a.error=null,a instanceof Group&&a.each(function(a){a.error=null},function(a){this.clearErrors(a)},this))},QueryBuilder.prototype.displayError=function(a){if(this.settings.display_errors)if(null===a.error)a.$el.removeClass("has-error");else{var b=this.lang.errors[a.error[0]]||a.error[0];b=Utils.fmt(b,a.error.slice(1)),b=this.change("displayError",b,a.error,a),a.$el.addClass("has-error").find(Selectors.error_container).eq(0).attr("title",b)}},QueryBuilder.prototype.triggerValidationError=function(a,b,c){$.isArray(b)||(b=[b]);var d=this.trigger("validationError",a,b,c);d.isDefaultPrevented()||(a.error=b)},QueryBuilder.prototype.destroy=function(){this.trigger("beforeDestroy"),this.status.generated_id&&this.$el.removeAttr("id"),this.clear(),this.model=null,this.$el.off(".queryBuilder").removeClass("query-builder").removeData("queryBuilder"),delete this.$el[0].queryBuilder},QueryBuilder.prototype.reset=function(){this.status.group_id=1,this.status.rule_id=0,this.model.root.empty(),this.addRule(this.model.root),this.trigger("afterReset")},QueryBuilder.prototype.clear=function(){this.status.group_id=0,this.status.rule_id=0,this.model.root&&(this.model.root.drop(),this.model.root=null),this.trigger("afterClear")},QueryBuilder.prototype.setOptions=function(a){$.each(a,function(a,b){QueryBuilder.modifiable_options.indexOf(a)!==-1&&(this.settings[a]=b)}.bind(this))},QueryBuilder.prototype.getModel=function(a){return a?Model(a):this.model.root},QueryBuilder.prototype.validate=function(){this.clearErrors();var a=this,b=function c(b){var d=0,e=0;return b.each(function(b){if(!b.filter)return a.triggerValidationError(b,"no_filter",null),void e++;if(0!==b.operator.nb_inputs){var c=a.validateValue(b,b.value);if(c!==!0)return a.triggerValidationError(b,c,b.value),void e++}d++},function(a){c(a)?d++:e++}),!(e>0)&&(!!(0!==d||a.settings.allow_empty&&b.isRoot())||(a.triggerValidationError(b,"empty_group",null),!1))}(this.model.root);return this.change("validate",b)},QueryBuilder.prototype.getRules=function(a){if(a=$.extend({get_flags:!1,validate:!0},a),a.validate&&!this.validate())return{};var b=this,c=function d(c){var e={condition:c.condition,rules:[]};if(c.data&&(e.data=$.extendext(!0,"replace",{},c.data)),a.get_flags){var f=b.getGroupFlags(c.flags,"all"===a.get_flags);$.isEmptyObject(f)||(e.flags=f)}return c.each(function(c){var d=null;0!==c.operator.nb_inputs&&(d=c.value);var f={id:c.filter.id,field:c.filter.field,type:c.filter.type,input:c.filter.input,operator:c.operator.type,value:d};if((c.filter.data||c.data)&&(f.data=$.extendext(!0,"replace",{},c.filter.data,c.data)),a.get_flags){var g=b.getRuleFlags(c.flags,"all"===a.get_flags);$.isEmptyObject(g)||(f.flags=g)}e.rules.push(b.change("ruleToJson",f,c))},function(a){e.rules.push(d(a))},this),b.change("groupToJson",e,c)}(this.model.root);return this.change("getRules",c)},QueryBuilder.prototype.setRules=function(a){$.isArray(a)&&(a={condition:this.settings.default_condition,rules:a}),a&&a.rules&&(0!==a.rules.length||this.settings.allow_empty)||Utils.error("RulesParse","Incorrect data object passed"),this.clear(),this.setRoot(!1,a.data,this.parseGroupFlags(a)),a=this.change("setRules",a);var b=this;!function c(a,d){null!==d&&(void 0===a.condition?a.condition=b.settings.default_condition:b.settings.conditions.indexOf(a.condition)==-1&&Utils.error("UndefinedCondition",'Invalid condition "{0}"',a.condition),d.condition=a.condition,a.rules.forEach(function(a){var e;if(void 0!==a.rules)if(b.settings.allow_groups!==-1&&b.settings.allow_groups<d.level)b.reset(),Utils.error("RulesParse","No more than {0} groups are allowed",b.settings.allow_groups);else{if(e=b.addGroup(d,!1,a.data,b.parseGroupFlags(a)),null===e)return;c(a,e)}else{if(a.empty||(void 0===a.id&&Utils.error("RulesParse","Missing rule field id"),void 0===a.operator&&(a.operator="equal")),e=b.addRule(d,a.data),null===e)return;a.empty||(e.filter=b.getFilterById(a.id),e.operator=b.getOperatorByType(a.operator),0!==e.operator.nb_inputs&&void 0!==a.value&&(e.value=a.value)),e.flags=b.parseRuleFlags(a),b.change("jsonToRule",e,a)!=e&&Utils.error("RulesParse","Plugin tried to change rule reference")}}),b.change("jsonToGroup",d,a)!=d&&Utils.error("RulesParse","Plugin tried to change group reference"))}(a,this.model.root)},QueryBuilder.prototype.validateValue=function(a,b){var c=a.filter.validation||{},d=!0;return d=c.callback?c.callback.call(this,b,a):this.validateValueInternal(a,b),this.change("validateValue",d,b,a)},QueryBuilder.prototype.validateValueInternal=function(a,b){var c,d=a.filter,e=a.operator,f=d.validation||{},g=!0;1===a.operator.nb_inputs&&(b=[b]);for(var h=0;h<e.nb_inputs;h++){switch(d.input){case"radio":if(void 0===b[h]){g=["radio_empty"];break}break;case"checkbox":if(void 0===b[h]||0===b[h].length){g=["checkbox_empty"];break}if(!e.multiple&&b[h].length>1){g=["operator_not_multiple",e.type];break}break;case"select":if(d.multiple){if(void 0===b[h]||0===b[h].length||d.placeholder&&b[h]==d.placeholder_value){g=["select_empty"];break}if(!e.multiple&&b[h].length>1){g=["operator_not_multiple",e.type];break}}else if(void 0===b[h]||d.placeholder&&b[h]==d.placeholder_value){g=["select_empty"];break}break;default:switch(QueryBuilder.types[d.type]){case"string":if(void 0===b[h]||0===b[h].length){g=["string_empty"];break}if(void 0!==f.min&&b[h].length<parseInt(f.min)){g=[this.getValidationMessage(f,"min","string_exceed_min_length"),f.min];break}if(void 0!==f.max&&b[h].length>parseInt(f.max)){g=[this.getValidationMessage(f,"max","string_exceed_max_length"),f.max];break}if(f.format&&("string"==typeof f.format&&(f.format=new RegExp(f.format)),!f.format.test(b[h]))){g=[this.getValidationMessage(f,"format","string_invalid_format"),f.format];break}break;case"number":if(void 0===b[h]||isNaN(b[h])){g=["number_nan"];break}if("integer"==d.type){if(parseInt(b[h])!=b[h]){g=["number_not_integer"];break}}else if(parseFloat(b[h])!=b[h]){g=["number_not_double"];break}if(void 0!==f.min&&b[h]<parseFloat(f.min)){g=[this.getValidationMessage(f,"min","number_exceed_min"),f.min];break}if(void 0!==f.max&&b[h]>parseFloat(f.max)){g=[this.getValidationMessage(f,"max","number_exceed_max"),f.max];break}if(void 0!==f.step&&"any"!==f.step){var i=(b[h]/f.step).toPrecision(14);if(parseInt(i)!=i){g=[this.getValidationMessage(f,"step","number_wrong_step"),f.step];break}}break;case"datetime":if(void 0===b[h]||0===b[h].length){g=["datetime_empty"];break}if(f.format){"moment"in window||Utils.error("MissingLibrary","MomentJS is required for Date/Time validation. Get it here http://momentjs.com");var j=moment(b[h],f.format);if(!j.isValid()){g=[this.getValidationMessage(f,"format","datetime_invalid"),f.format];break}if(f.min&&j<moment(f.min,f.format)){g=[this.getValidationMessage(f,"min","datetime_exceed_min"),f.min];break}if(f.max&&j>moment(f.max,f.format)){g=[this.getValidationMessage(f,"max","datetime_exceed_max"),f.max];break}}break;case"boolean":if(c=b[h].trim().toLowerCase(),"true"!==c&&"false"!==c&&"1"!==c&&"0"!==c&&1!==b[h]&&0!==b[h]){g=["boolean_not_valid"];break}}}if(g!==!0)break}return g},QueryBuilder.prototype.nextGroupId=function(){return this.status.id+"_group_"+this.status.group_id++},QueryBuilder.prototype.nextRuleId=function(){return this.status.id+"_rule_"+this.status.rule_id++},QueryBuilder.prototype.getOperators=function(a){"string"==typeof a&&(a=this.getFilterById(a));for(var b=[],c=0,d=this.operators.length;c<d;c++){if(a.operators){if(a.operators.indexOf(this.operators[c].type)==-1)continue}else if(this.operators[c].apply_to.indexOf(QueryBuilder.types[a.type])==-1)continue;b.push(this.operators[c])}return a.operators&&b.sort(function(b,c){return a.operators.indexOf(b.type)-a.operators.indexOf(c.type)}),this.change("getOperators",b,a)},QueryBuilder.prototype.getFilterById=function(a){if("-1"==a)return null;for(var b=0,c=this.filters.length;b<c;b++)if(this.filters[b].id==a)return this.filters[b];Utils.error("UndefinedFilter",'Undefined filter "{0}"',a)},QueryBuilder.prototype.getOperatorByType=function(a){if("-1"==a)return null;for(var b=0,c=this.operators.length;b<c;b++)if(this.operators[b].type==a)return this.operators[b];Utils.error("UndefinedOperator",'Undefined operator "{0}"',a)},QueryBuilder.prototype.getRuleValue=function(a){var b=a.filter,c=a.operator,d=[];if(b.valueGetter)d=b.valueGetter.call(this,a);else{for(var e=a.$el.find(Selectors.value_container),f=0;f<c.nb_inputs;f++){var g,h=Utils.escapeElementId(a.id+"_value_"+f);switch(b.input){case"radio":d.push(e.find("[name="+h+"]:checked").val());break;case"checkbox":g=[],e.find("[name="+h+"]:checked").each(function(){g.push($(this).val())}),d.push(g);break;case"select":b.multiple?(g=[],e.find("[name="+h+"] option:selected").each(function(){g.push($(this).val())}),d.push(g)):d.push(e.find("[name="+h+"] option:selected").val());break;default:d.push(e.find("[name="+h+"]").val())}}c.multiple&&b.value_separator&&(d=d.map(function(a){return a.split(b.value_separator)})),1===c.nb_inputs&&(d=d[0]),b.valueParser&&(d=b.valueParser.call(this,a,d))}return this.change("getRuleValue",d,a)},QueryBuilder.prototype.setRuleValue=function(a,b){var c=a.filter,d=a.operator;if(c.valueSetter)c.valueSetter.call(this,a,b);else{var e=a.$el.find(Selectors.value_container);b=1==d.nb_inputs?[b]:b;for(var f=0;f<d.nb_inputs;f++){var g=Utils.escapeElementId(a.id+"_value_"+f);switch(c.input){case"radio":e.find("[name="+g+'][value="'+b[f]+'"]').prop("checked",!0).trigger("change");break;case"checkbox":$.isArray(b[f])||(b[f]=[b[f]]),b[f].forEach(function(a){e.find("[name="+g+'][value="'+a+'"]').prop("checked",!0).trigger("change")});break;default:d.multiple&&c.value_separator&&$.isArray(b[f])&&(b[f]=b[f].join(c.value_separator)),e.find("[name="+g+"]").val(b[f]).trigger("change")}}}},QueryBuilder.prototype.parseRuleFlags=function(a){var b=$.extend({},this.settings.default_rule_flags);return a.readonly&&$.extend(b,{filter_readonly:!0,operator_readonly:!0,value_readonly:!0,no_delete:!0}),a.flags&&$.extend(b,a.flags),this.change("parseRuleFlags",b,a)},QueryBuilder.prototype.getRuleFlags=function(a,b){if(b)return $.extend({},a);var c={};return $.each(this.settings.default_rule_flags,function(b,d){a[b]!==d&&(c[b]=a[b])}),c},QueryBuilder.prototype.parseGroupFlags=function(a){var b=$.extend({},this.settings.default_group_flags);return a.readonly&&$.extend(b,{condition_readonly:!0,no_add_rule:!0,no_add_group:!0,no_delete:!0}),a.flags&&$.extend(b,a.flags),this.change("parseGroupFlags",b,a)},QueryBuilder.prototype.getGroupFlags=function(a,b){if(b)return $.extend({},a);var c={};return $.each(this.settings.default_group_flags,function(b,d){a[b]!==d&&(c[b]=a[b])}),c},QueryBuilder.prototype.translateLabel=function(a){return"object"==typeof a?a[this.settings.lang_code]||a.en:a},QueryBuilder.prototype.getValidationMessage=function(a,b,c){return a.messages&&a.messages[b]||c},QueryBuilder.templates.group='<dl id="{{= it.group_id }}" class="rules-group-container">   <dt class="rules-group-header">     <div class="btn-group pull-right group-actions">       <button type="button" class="btn btn-xs btn-success" data-add="rule">         <i class="{{= it.icons.add_rule }}"></i> {{= it.lang.add_rule }}       </button>       {{? it.settings.allow_groups===-1 || it.settings.allow_groups>=it.level }}         <button type="button" class="btn btn-xs btn-success" data-add="group">           <i class="{{= it.icons.add_group }}"></i> {{= it.lang.add_group }}         </button>       {{?}}       {{? it.level>1 }}         <button type="button" class="btn btn-xs btn-danger" data-delete="group">           <i class="{{= it.icons.remove_group }}"></i> {{= it.lang.delete_group }}         </button>       {{?}}     </div>     <div class="btn-group group-conditions">       {{~ it.conditions: condition }}         <label class="btn btn-xs btn-primary">           <input type="radio" name="{{= it.group_id }}_cond" value="{{= condition }}"> {{= it.lang.conditions[condition] || condition }}         </label>       {{~}}     </div>     {{? it.settings.display_errors }}       <div class="error-container"><i class="{{= it.icons.error }}"></i></div>     {{?}}   </dt>   <dd class=rules-group-body>     <ul class=rules-list></ul>   </dd> </dl>',QueryBuilder.templates.rule='<li id="{{= it.rule_id }}" class="rule-container">   <div class="rule-header">     <div class="btn-group pull-right rule-actions">       <button type="button" class="btn btn-xs btn-danger" data-delete="rule">         <i class="{{= it.icons.remove_rule }}"></i> {{= it.lang.delete_rule }}       </button>     </div>   </div>   {{? it.settings.display_errors }}     <div class="error-container"><i class="{{= it.icons.error }}"></i></div>   {{?}}   <div class="rule-filter-container"></div>   <div class="rule-operator-container"></div>   <div class="rule-value-container"></div> </li>',QueryBuilder.templates.filterSelect='{{ var optgroup = null; }} <select class="form-control" name="{{= it.rule.id }}_filter">   {{? it.settings.display_empty_filter }}     <option value="-1">{{= it.settings.select_placeholder }}</option>   {{?}}   {{~ it.filters: filter }}     {{? optgroup !== filter.optgroup }}       {{? optgroup !== null }}</optgroup>{{?}}       {{? (optgroup = filter.optgroup) !== null }}         <optgroup label="{{= it.translate(it.settings.optgroups[optgroup]) }}">       {{?}}     {{?}}     <option value="{{= filter.id }}">{{= it.translate(filter.label) }}</option>   {{~}}   {{? optgroup !== null }}</optgroup>{{?}} </select>',QueryBuilder.templates.operatorSelect='{{? it.operators.length === 1 }} <span> {{= it.lang.operators[it.operators[0].type] || it.operators[0].type }} </span> {{?}} {{ var optgroup = null; }} <select class="form-control {{? it.operators.length === 1 }}hide{{?}}" name="{{= it.rule.id }}_operator">   {{~ it.operators: operator }}     {{? optgroup !== operator.optgroup }}       {{? optgroup !== null }}</optgroup>{{?}}       {{? (optgroup = operator.optgroup) !== null }}         <optgroup label="{{= it.translate(it.settings.optgroups[optgroup]) }}">       {{?}}     {{?}}     <option value="{{= operator.type }}">{{= it.lang.operators[operator.type] || operator.type }}</option>   {{~}}   {{? optgroup !== null }}</optgroup>{{?}} </select>',
QueryBuilder.prototype.getGroupTemplate=function(a,b){var c=this.templates.group({builder:this,group_id:a,level:b,conditions:this.settings.conditions,icons:this.icons,lang:this.lang,settings:this.settings});return this.change("getGroupTemplate",c,b)},QueryBuilder.prototype.getRuleTemplate=function(a){var b=this.templates.rule({builder:this,rule_id:a,icons:this.icons,lang:this.lang,settings:this.settings});return this.change("getRuleTemplate",b)},QueryBuilder.prototype.getRuleFilterSelect=function(a,b){var c=this.templates.filterSelect({builder:this,rule:a,filters:b,icons:this.icons,lang:this.lang,settings:this.settings,translate:this.translateLabel});return this.change("getRuleFilterSelect",c,a)},QueryBuilder.prototype.getRuleOperatorSelect=function(a,b){var c=this.templates.operatorSelect({builder:this,rule:a,operators:b,icons:this.icons,lang:this.lang,settings:this.settings,translate:this.translateLabel});return this.change("getRuleOperatorSelect",c,a)},QueryBuilder.prototype.getRuleInput=function(a,b){var c=a.filter,d=a.filter.validation||{},e=a.id+"_value_"+b,f=c.vertical?" class=block":"",g="";if("function"==typeof c.input)g=c.input.call(this,a,e);else switch(c.input){case"radio":case"checkbox":Utils.iterateOptions(c.values,function(a,b){g+="<label"+f+'><input type="'+c.input+'" name="'+e+'" value="'+a+'"> '+b+"</label> "});break;case"select":g+='<select class="form-control" name="'+e+'"'+(c.multiple?" multiple":"")+">",c.placeholder&&(g+='<option value="'+c.placeholder_value+'" disabled selected>'+c.placeholder+"</option>"),Utils.iterateOptions(c.values,function(a,b){g+='<option value="'+a+'">'+b+"</option> "}),g+="</select>";break;case"textarea":g+='<textarea class="form-control" name="'+e+'"',c.size&&(g+=' cols="'+c.size+'"'),c.rows&&(g+=' rows="'+c.rows+'"'),void 0!==d.min&&(g+=' minlength="'+d.min+'"'),void 0!==d.max&&(g+=' maxlength="'+d.max+'"'),c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),g+="></textarea>";break;default:switch(QueryBuilder.types[c.type]){case"number":g+='<input class="form-control" type="number" name="'+e+'"',void 0!==d.step&&(g+=' step="'+d.step+'"'),void 0!==d.min&&(g+=' min="'+d.min+'"'),void 0!==d.max&&(g+=' max="'+d.max+'"'),c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),c.size&&(g+=' size="'+c.size+'"'),g+=">";break;default:g+='<input class="form-control" type="text" name="'+e+'"',c.placeholder&&(g+=' placeholder="'+c.placeholder+'"'),"string"===c.type&&void 0!==d.min&&(g+=' minlength="'+d.min+'"'),"string"===c.type&&void 0!==d.max&&(g+=' maxlength="'+d.max+'"'),c.size&&(g+=' size="'+c.size+'"'),g+=">"}}return this.change("getRuleInput",g,a,e)},$.extend(Model.prototype,{trigger:function(a){return this.$.triggerHandler(a,Array.prototype.slice.call(arguments,1)),this},on:function(){return this.$.on.apply(this.$,Array.prototype.slice.call(arguments)),this},off:function(){return this.$.off.apply(this.$,Array.prototype.slice.call(arguments)),this},once:function(){return this.$.one.apply(this.$,Array.prototype.slice.call(arguments)),this}}),Model.getModel=function(a){return a?a instanceof Node?a:$(a).data("queryBuilderModel"):null},Model.defineModelProperties=function(a,b){b.forEach(function(b){Object.defineProperty(a.prototype,b,{enumerable:!0,get:function(){return this.__[b]},set:function(a){var c=null!==this.__[b]&&"object"==typeof this.__[b]?$.extend({},this.__[b]):this.__[b];this.__[b]=a,null!==this.model&&this.model.trigger("update",this,b,a,c)}})})};var Node=function(a,b){return this instanceof Node?(Object.defineProperty(this,"__",{value:{}}),b.data("queryBuilderModel",this),this.__.level=1,this.__.error=null,this.__.data=void 0,this.$el=b,this.id=b[0].id,this.model=null,void(this.parent=a)):new Node};Model.defineModelProperties(Node,["level","error","data","flags"]),Object.defineProperty(Node.prototype,"parent",{enumerable:!0,get:function(){return this.__.parent},set:function(a){this.__.parent=a,this.level=null===a?1:a.level+1,this.model=null===a?null:a.model}}),Node.prototype.isRoot=function(){return 1===this.level},Node.prototype.getPos=function(){return this.isRoot()?-1:this.parent.getNodePos(this)},Node.prototype.drop=function(){var a=this.model;this.isRoot()||this.parent._removeNode(this),null!==a&&a.trigger("drop",this)},Node.prototype.moveAfter=function(a){if(!this.isRoot())return this._move(a.parent,a.getPos()+1),this},Node.prototype.moveAtBegin=function(a){if(!this.isRoot())return void 0===a&&(a=this.parent),this._move(a,0),this},Node.prototype.moveAtEnd=function(a){if(!this.isRoot())return void 0===a&&(a=this.parent),this._move(a,0===a.length()?0:a.length()-1),this},Node.prototype._move=function(a,b){this.parent._removeNode(this),a._appendNode(this,b,!1),null!==this.model&&this.model.trigger("move",this,a,b)};var Group=function(a,b){return this instanceof Group?(Node.call(this,a,b),this.rules=[],void(this.__.condition=null)):new Group(a,b)};Group.prototype=Object.create(Node.prototype),Group.prototype.constructor=Group,Model.defineModelProperties(Group,["condition"]),Group.prototype.empty=function(){this.each("reverse",function(a){a.drop()},function(a){a.drop()})},Group.prototype.drop=function(){this.empty(),Node.prototype.drop.call(this)},Group.prototype.length=function(){return this.rules.length},Group.prototype._appendNode=function(a,b,c){return void 0===b&&(b=this.length()),this.rules.splice(b,0,a),a.parent=this,c&&null!==this.model&&this.model.trigger("add",a,b),a},Group.prototype.addGroup=function(a,b){return this._appendNode(new Group(this,a),b,!0)},Group.prototype.addRule=function(a,b){return this._appendNode(new Rule(this,a),b,!0)},Group.prototype._removeNode=function(a){var b=this.getNodePos(a);return b!==-1&&(a.parent=null,this.rules.splice(b,1)),this},Group.prototype.getNodePos=function(a){return this.rules.indexOf(a)},Group.prototype.each=function(a,b,c,d){"function"==typeof a&&(d=c,c=b,b=a,a=!1),d=void 0===d?null:d;for(var e=a?this.rules.length-1:0,f=a?0:this.rules.length-1,g=a?-1:1,h=function(){return a?e>=f:e<=f},i=!1;h()&&(this.rules[e]instanceof Group?void 0!==c&&(i=c.call(d,this.rules[e])===!1):i=b.call(d,this.rules[e])===!1,!i);e+=g);return!i},Group.prototype.contains=function(a,b){return this.getNodePos(a)!==-1||!!b&&!this.each(function(a){return!0},function(b){return!b.contains(a,!0)})};var Rule=function(a,b){return this instanceof Rule?(Node.call(this,a,b),this.__.filter=null,this.__.operator=null,this.__.flags={},void(this.__.value=void 0)):new Rule(a,b)};Rule.prototype=Object.create(Node.prototype),Rule.prototype.constructor=Rule,Model.defineModelProperties(Rule,["filter","operator","value"]),QueryBuilder.Group=Group,QueryBuilder.Rule=Rule;var Utils=QueryBuilder.utils={};Utils.iterateOptions=function(a,b){a&&($.isArray(a)?a.forEach(function(a){$.isPlainObject(a)?$.each(a,function(a,c){return b(a,c),!1}):b(a,a)}):$.each(a,function(a,c){b(a,c)}))},Utils.fmt=function(a,b){return Array.isArray(b)||(b=Array.prototype.slice.call(arguments,1)),a.replace(/{([0-9]+)}/g,function(a,c){return b[parseInt(c)]})},Utils.error=function(a,b,c){Array.isArray(c)||(c=Array.prototype.slice.call(arguments,2));var d=new Error(Utils.fmt(b,c));throw d.name=a+"Error",d.args=c,d},Utils.changeType=function(a,b,c){switch(b){case"integer":return parseInt(a);case"double":return parseFloat(a);case"boolean":var d="true"===a.trim().toLowerCase()||"1"===a.trim()||1===a;return c?d?1:0:d;default:return a}},Utils.escapeString=function(a){return"string"!=typeof a?a:a.replace(/[\0\n\r\b\\\'\"]/g,function(a){switch(a){case"\0":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";default:return"\\"+a}}).replace(/\t/g,"\\t").replace(/\x1a/g,"\\Z")},Utils.escapeRegExp=function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},Utils.escapeElementId=function(a){return a?a.replace(/(\\)?([:.\[\],])/g,function(a,b,c){return b?a:"\\"+c}):a},Utils.groupSort=function(a,b){var c=[],d=[];return a.forEach(function(a){var e;a[b]?(e=c.lastIndexOf(a[b]),e==-1?e=c.length:e++):e=c.length,c.splice(e,0,a[b]),d.splice(e,0,a)}),d},$.fn.queryBuilder=function(a){0===this.length&&Utils.error("Config","No target defined"),this.length>1&&Utils.error("Config","Unable to initialize on multiple target");var b=this.data("queryBuilder"),c="object"==typeof a&&a||{};return b||"destroy"!=a?(b||this.data("queryBuilder",new QueryBuilder(this,c)),"string"==typeof a?b[a].apply(b,Array.prototype.slice.call(arguments,1)):this):this},$.fn.queryBuilder.constructor=QueryBuilder,$.fn.queryBuilder.defaults=QueryBuilder.defaults,$.fn.queryBuilder.extend=QueryBuilder.extend,$.fn.queryBuilder.define=QueryBuilder.define,$.fn.queryBuilder.regional=QueryBuilder.regional,QueryBuilder.define("bt-checkbox",function(a){if("glyphicons"==a.font){var b=document.createElement("style");b.innerHTML='.checkbox input[type=checkbox]:checked + label:after {     font-family: "Glyphicons Halflings";     content: "\\e013"; } .checkbox label:after {     padding-left: 4px;     padding-top: 2px;     font-size: 9px; }',document.body.appendChild(b)}this.on("getRuleInput.filter",function(b,c,d){var e=c.filter;if(("radio"===e.input||"checkbox"===e.input)&&!e.plugin){b.value="",e.colors||(e.colors={}),e.color&&(e.colors._def_=e.color);var f=e.vertical?' style="display:block"':"",g=0;Utils.iterateOptions(e.values,function(c,h){var i=e.colors[c]||e.colors._def_||a.color,j=d+"_"+g++;b.value+="<div"+f+' class="'+e.input+" "+e.input+"-"+i+'">   <input type="'+e.input+'" name="'+d+'" id="'+j+'" value="'+c+'">   <label for="'+j+'">'+h+"</label> </div>"})}})},{font:"glyphicons",color:"default"}),QueryBuilder.define("bt-selectpicker",function(a){$.fn.selectpicker&&$.fn.selectpicker.Constructor||Utils.error("MissingLibrary",'Bootstrap Select is required to use "bt-selectpicker" plugin. Get it here: http://silviomoreto.github.io/bootstrap-select'),this.on("afterCreateRuleFilters",function(b,c){c.$el.find(Selectors.rule_filter).removeClass("form-control").selectpicker(a)}),this.on("afterCreateRuleOperators",function(b,c){c.$el.find(Selectors.rule_operator).removeClass("form-control").selectpicker(a)}),this.on("afterUpdateRuleFilter",function(a,b){b.$el.find(Selectors.rule_filter).selectpicker("render")}),this.on("afterUpdateRuleOperator",function(a,b){b.$el.find(Selectors.rule_operator).selectpicker("render")})},{container:"body",style:"btn-inverse btn-xs",width:"auto",showIcon:!1}),QueryBuilder.define("bt-tooltip-errors",function(a){$.fn.tooltip&&$.fn.tooltip.Constructor&&$.fn.tooltip.Constructor.prototype.fixTitle||Utils.error("MissingLibrary",'Bootstrap Tooltip is required to use "bt-tooltip-errors" plugin. Get it here: http://getbootstrap.com');var b=this;this.on("getRuleTemplate.filter getGroupTemplate.filter",function(a){var b=$(a.value);b.find(Selectors.error_container).attr("data-toggle","tooltip"),a.value=b.prop("outerHTML")}),this.model.on("update",function(c,d,e){"error"==e&&b.settings.display_errors&&d.$el.find(Selectors.error_container).eq(0).tooltip(a).tooltip("hide").tooltip("fixTitle")})},{placement:"right"}),QueryBuilder.extend({setFilters:function(a,b){var c=this;void 0===b&&(b=a,a=!1),b=this.checkFilters(b),b=this.change("setFilters",b);var d=b.map(function(a){return a.id});if(a||!function f(a){a.each(function(a){a.filter&&d.indexOf(a.filter.id)===-1&&Utils.error("ChangeFilter",'A rule is using filter "{0}"',a.filter.id)},f)}(this.model.root),this.filters=b,function g(a){a.each(!0,function(a){a.filter&&d.indexOf(a.filter.id)===-1?a.drop():(c.createRuleFilters(a),a.$el.find(Selectors.rule_filter).val(a.filter?a.filter.id:"-1"),c.trigger("afterUpdateRuleFilter",a))},g)}(this.model.root),this.settings.plugins&&(this.settings.plugins["unique-filter"]&&this.updateDisabledFilters(),this.settings.plugins["bt-selectpicker"]&&this.$el.find(Selectors.rule_filter).selectpicker("render")),this.settings.default_filter)try{this.getFilterById(this.settings.default_filter)}catch(e){this.settings.default_filter=null}this.trigger("afterSetFilters",b)},addFilter:function(a,b){void 0===b||"#end"==b?b=this.filters.length:"#start"==b&&(b=0),$.isArray(a)||(a=[a]);var c=$.extend(!0,[],this.filters);parseInt(b)==b?Array.prototype.splice.apply(c,[b,0].concat(a)):this.filters.some(function(a,c){if(a.id==b)return b=c+1,!0})?Array.prototype.splice.apply(c,[b,0].concat(a)):Array.prototype.push.apply(c,a),this.setFilters(c)},removeFilter:function(a,b){var c=$.extend(!0,[],this.filters);"string"==typeof a&&(a=[a]),c=c.filter(function(b){return a.indexOf(b.id)===-1}),this.setFilters(b,c)}}),QueryBuilder.define("filter-description",function(a){"inline"===a.mode?this.on("afterUpdateRuleFilter",function(b,c){var d=c.$el.find("p.filter-description");c.filter&&c.filter.description?(0===d.length?(d=$('<p class="filter-description"></p>'),d.appendTo(c.$el)):d.show(),d.html('<i class="'+a.icon+'"></i> '+c.filter.description)):d.hide()}):"popover"===a.mode?($.fn.popover&&$.fn.popover.Constructor&&$.fn.popover.Constructor.prototype.fixTitle||Utils.error("MissingLibrary",'Bootstrap Popover is required to use "filter-description" plugin. Get it here: http://getbootstrap.com'),this.on("afterUpdateRuleFilter",function(b,c){var d=c.$el.find("button.filter-description");c.filter&&c.filter.description?(0===d.length?(d=$('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="popover"><i class="'+a.icon+'"></i></button>'),d.prependTo(c.$el.find(Selectors.rule_actions)),d.popover({placement:"left",container:"body",html:!0}),d.on("mouseout",function(){d.popover("hide")})):d.show(),d.data("bs.popover").options.content=c.filter.description,d.attr("aria-describedby")&&d.popover("show")):(d.hide(),d.data("bs.popover")&&d.popover("hide"))})):"bootbox"===a.mode&&("bootbox"in window||Utils.error("MissingLibrary",'Bootbox is required to use "filter-description" plugin. Get it here: http://bootboxjs.com'),this.on("afterUpdateRuleFilter",function(b,c){var d=c.$el.find("button.filter-description");c.filter&&c.filter.description?(0===d.length&&(d=$('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="bootbox"><i class="'+a.icon+'"></i></button>'),d.prependTo(c.$el.find(Selectors.rule_actions)),d.on("click",function(){bootbox.alert(d.data("description"))})),d.data("description",c.filter.description)):d.hide()}))},{icon:"glyphicon glyphicon-info-sign",mode:"popover"}),QueryBuilder.defaults({operatorOpposites:{equal:"not_equal",not_equal:"equal","in":"not_in",not_in:"in",less:"greater_or_equal",less_or_equal:"greater",greater:"less_or_equal",greater_or_equal:"less",between:"not_between",not_between:"between",begins_with:"not_begins_with",not_begins_with:"begins_with",contains:"not_contains",not_contains:"contains",ends_with:"not_ends_with",not_ends_with:"ends_with",is_empty:"is_not_empty",is_not_empty:"is_empty",is_null:"is_not_null",is_not_null:"is_null"},conditionOpposites:{AND:"OR",OR:"AND"}}),QueryBuilder.define("invert",function(a){var b=this;this.on("afterInit",function(){b.$el.on("click.queryBuilder","[data-invert=group]",function(){var c=$(this).closest(Selectors.group_container);b.invert(Model(c),a)}),a.display_rules_button&&a.invert_rules&&b.$el.on("click.queryBuilder","[data-invert=rule]",function(){var c=$(this).closest(Selectors.rule_container);b.invert(Model(c),a)})}),this.on("getGroupTemplate.filter",function(c,d){var e=$(c.value);e.find(Selectors.condition_container).after('<button type="button" class="btn btn-xs btn-default" data-invert="group"><i class="'+a.icon+'"></i> '+b.lang.invert+"</button>"),c.value=e.prop("outerHTML")}),a.display_rules_button&&a.invert_rules&&this.on("getRuleTemplate.filter",function(c){var d=$(c.value);d.find(Selectors.rule_actions).prepend('<button type="button" class="btn btn-xs btn-default" data-invert="rule"><i class="'+a.icon+'"></i> '+b.lang.invert+"</button>"),c.value=d.prop("outerHTML")})},{icon:"glyphicon glyphicon-random",recursive:!0,invert_rules:!0,display_rules_button:!1,silent_fail:!1}),QueryBuilder.extend({invert:function(a,b){if(!(a instanceof Node)){if(!this.model.root)return;b=a,a=this.model.root}if("object"!=typeof b&&(b={}),void 0===b.recursive&&(b.recursive=!0),void 0===b.invert_rules&&(b.invert_rules=!0),void 0===b.silent_fail&&(b.silent_fail=!1),void 0===b.trigger&&(b.trigger=!0),a instanceof Group){if(this.settings.conditionOpposites[a.condition]?a.condition=this.settings.conditionOpposites[a.condition]:b.silent_fail||Utils.error("InvertCondition",'Unknown inverse of condition "{0}"',a.condition),b.recursive){var c=$.extend({},b,{trigger:!1});a.each(function(a){b.invert_rules&&this.invert(a,c)},function(a){this.invert(a,c)},this)}}else if(a instanceof Rule&&a.operator&&!a.filter.no_invert)if(this.settings.operatorOpposites[a.operator.type]){var d=this.settings.operatorOpposites[a.operator.type];a.filter.operators&&a.filter.operators.indexOf(d)==-1||(a.operator=this.getOperatorByType(d))}else b.silent_fail||Utils.error("InvertOperator",'Unknown inverse of operator "{0}"',a.operator.type);b.trigger&&this.trigger("afterInvert",a,b)}}),QueryBuilder.defaults({mongoOperators:{equal:function(a){return a[0]},not_equal:function(a){return{$ne:a[0]}},"in":function(a){return{$in:a}},not_in:function(a){return{$nin:a}},less:function(a){return{$lt:a[0]}},less_or_equal:function(a){return{$lte:a[0]}},greater:function(a){return{$gt:a[0]}},greater_or_equal:function(a){return{$gte:a[0]}},between:function(a){return{$gte:a[0],$lte:a[1]}},not_between:function(a){return{$lt:a[0],$gt:a[1]}},begins_with:function(a){return{$regex:"^"+Utils.escapeRegExp(a[0])}},not_begins_with:function(a){return{$regex:"^(?!"+Utils.escapeRegExp(a[0])+")"}},contains:function(a){return{$regex:Utils.escapeRegExp(a[0])}},not_contains:function(a){return{$regex:"^((?!"+Utils.escapeRegExp(a[0])+").)*$",$options:"s"}},ends_with:function(a){return{$regex:Utils.escapeRegExp(a[0])+"$"}},not_ends_with:function(a){return{$regex:"(?<!"+Utils.escapeRegExp(a[0])+")$"}},is_empty:function(a){return""},is_not_empty:function(a){return{$ne:""}},is_null:function(a){return null},is_not_null:function(a){return{$ne:null}}},mongoRuleOperators:{$ne:function(a){return a=a.$ne,{val:a,op:null===a?"is_not_null":""===a?"is_not_empty":"not_equal"}},eq:function(a){return{val:a,op:null===a?"is_null":""===a?"is_empty":"equal"}},$regex:function(a){return a=a.$regex,"^(?!"==a.slice(0,4)&&")"==a.slice(-1)?{val:a.slice(4,-1),op:"not_begins_with"}:"^((?!"==a.slice(0,5)&&").)*$"==a.slice(-5)?{val:a.slice(5,-5),op:"not_contains"}:"(?<!"==a.slice(0,4)&&")$"==a.slice(-2)?{val:a.slice(4,-2),op:"not_ends_with"}:"$"==a.slice(-1)?{val:a.slice(0,-1),op:"ends_with"}:"^"==a.slice(0,1)?{val:a.slice(1),op:"begins_with"}:{val:a,op:"contains"}},between:function(a){return{val:[a.$gte,a.$lte],op:"between"}},not_between:function(a){return{val:[a.$lt,a.$gt],op:"not_between"}},$in:function(a){return{val:a.$in,op:"in"}},$nin:function(a){return{val:a.$nin,op:"not_in"}},$lt:function(a){return{val:a.$lt,op:"less"}},$lte:function(a){return{val:a.$lte,op:"less_or_equal"}},$gt:function(a){return{val:a.$gt,op:"greater"}},$gte:function(a){return{val:a.$gte,op:"greater_or_equal"}}}}),QueryBuilder.extend({getMongo:function(a){a=void 0===a?this.getRules():a;var b=this;return function c(a){if(a.condition||(a.condition=b.settings.default_condition),["AND","OR"].indexOf(a.condition.toUpperCase())===-1&&Utils.error("UndefinedMongoCondition",'Unable to build MongoDB query with condition "{0}"',a.condition),!a.rules)return{};var d=[];a.rules.forEach(function(a){if(a.rules&&a.rules.length>0)d.push(c(a));else{var e=b.settings.mongoOperators[a.operator],f=b.getOperatorByType(a.operator),g=[];void 0===e&&Utils.error("UndefinedMongoOperator",'Unknown MongoDB operation for operator "{0}"',a.operator),0!==f.nb_inputs&&(a.value instanceof Array||(a.value=[a.value]),a.value.forEach(function(b){g.push(Utils.changeType(b,a.type,!1))}));var h={},i=b.change("getMongoDBField",a.field,a);h[i]=e.call(b,g),d.push(b.change("ruleToMongo",h,a,g,e))}});var e={};return e["$"+a.condition.toLowerCase()]=d,b.change("groupToMongo",e,a)}(a)},getRulesFromMongo:function(a){if(void 0===a||null===a)return null;var b=this;if(a=b.change("parseMongoNode",a),"rules"in a&&"condition"in a)return a;var c=andOr(a);return c||Utils.error("MongoParse","Invalid MongoDB query format"),function d(a,c){var e=a[c],f=[];return e.forEach(function(a){if(a=b.change("parseMongoNode",a),"rules"in a&&"condition"in a)return void f.push(a);if("id"in a&&"operator"in a&&"value"in a)return void f.push(a);var c=andOr(a);if(c)f.push(d(a,c));else{var e=Object.keys(a)[0],g=a[e],h=determineMongoOperator(g,e);void 0===h&&Utils.error("MongoParse","Invalid MongoDB query format");var i=b.settings.mongoRuleOperators[h];void 0===i&&Utils.error("UndefinedMongoOperator",'JSON Rule operation unknown for operator "{0}"',h);var j=i.call(b,g),k=b.change("mongoToRule",{id:b.change("getMongoDBFieldID",e,g),field:e,operator:j.op,value:j.val},a);f.push(k)}}),b.change("mongoToGroup",{condition:c.replace("$","").toUpperCase(),rules:f},a)}(a,c)},setRulesFromMongo:function(a){this.setRules(this.getRulesFromMongo(a))}}),Selectors.group_not=Selectors.group_header+" [data-not=group]",Model.defineModelProperties(Group,["not"]),QueryBuilder.define("not-group",function(a){var b=this;this.on("afterInit",function(){b.$el.on("click.queryBuilder","[data-not=group]",function(){var a=$(this).closest(Selectors.group_container),b=Model(a);b.not=!b.not}),b.model.on("update",function(a,c,d){c instanceof Group&&"not"===d&&b.updateGroupNot(c)})}),this.on("afterAddGroup",function(a,b){b.__.not=!1}),this.on("getGroupTemplate.filter",function(c,d){var e=$(c.value);e.find(Selectors.condition_container).prepend('<button type="button" class="btn btn-xs btn-default" data-not="group"><i class="'+a.icon_unchecked+'"></i> '+b.lang.NOT+"</button>"),c.value=e.prop("outerHTML")}),this.on("groupToJson.filter",function(a,b){a.value.not=b.not}),this.on("jsonToGroup.filter",function(a,b){a.value.not=!!b.not}),this.on("groupToSQL.filter",function(a,b){b.not&&(a.value="NOT ( "+a.value+" )")}),this.on("parseSQLNode.filter",function(a){a.value.name&&"NOT"==a.value.name.toUpperCase()&&(a.value=a.value.arguments.value[0],a.value.not=!0)}),this.on("sqlToGroup.filter",function(a,b){a.value.not=!!b.not}),this.on("groupToMongo.filter",function(a,b){var c="$"+b.condition.toLowerCase();b.not&&a.value[c]&&(a.value={$nor:[a.value]})}),this.on("parseMongoNode.filter",function(a){var b=Object.keys(a.value);"$nor"==b[0]&&(a.value=a.value[b[0]][0],a.value.not=!0)}),this.on("mongoToGroup.filter",function(a,b){a.value.not=!!b.not})},{icon_unchecked:"glyphicon glyphicon-unchecked",icon_checked:"glyphicon glyphicon-check"}),QueryBuilder.extend({updateGroupNot:function(a){var b=this.plugins["not-group"];a.$el.find(">"+Selectors.group_not).toggleClass("active",a.not).find("i").attr("class",a.not?b.icon_checked:b.icon_unchecked),this.trigger("afterUpdateGroupNot",a)}}),Selectors.rule_and_group_containers=Selectors.rule_container+", "+Selectors.group_container,Selectors.drag_handle=".drag-handle",QueryBuilder.define("sortable",function(a){"interact"in window||Utils.error("MissingLibrary",'interact.js is required to use "sortable" plugin. Get it here: http://interactjs.io'),interact.dynamicDrop(!0),interact.pointerMoveTolerance(10);var b,c,d;this.on("afterAddRule afterAddGroup",function(a,e){e!=b&&(interact(e.$el[0]).allowFrom(Selectors.drag_handle).draggable({onstart:function(a){d=Model(a.target),c=d.$el.clone().appendTo(d.$el.parent()).width(d.$el.outerWidth()).addClass("dragging");var e=$('<div class="rule-placeholder">&nbsp;</div>').height(d.$el.outerHeight());b=d.parent.addRule(e,d.getPos()),d.$el.hide()},onmove:function(a){c[0].style.top=a.clientY-15+"px",c[0].style.left=a.clientX-15+"px"},onend:function(a){c.remove(),c=void 0,b.drop(),b=void 0,d.$el.show()}}),interact(e.$el[0]).dropzone({accept:Selectors.rule_and_group_containers,ondragenter:function(a){moveSortableToTarget(b,$(a.target))},ondrop:function(a){moveSortableToTarget(d,$(a.target))}}),e instanceof Group&&interact(e.$el.find(Selectors.group_header)[0]).dropzone({accept:Selectors.rule_and_group_containers,ondragenter:function(a){moveSortableToTarget(b,$(a.target))},ondrop:function(a){moveSortableToTarget(d,$(a.target))}}))}),this.on("beforeDeleteRule beforeDeleteGroup",function(a,b){a.isDefaultPrevented()||(interact(b.$el[0]).unset(),b instanceof Group&&interact(b.$el.find(Selectors.group_header)[0]).unset())}),this.on("parseRuleFlags.filter",function(b){void 0===b.value.no_sortable&&(b.value.no_sortable=a.default_no_sortable)}),this.on("afterApplyRuleFlags",function(a,b){b.flags.no_sortable&&b.$el.find(".drag-handle").remove()}),this.on("parseGroupFlags.filter",function(b){void 0===b.value.no_sortable&&(b.value.no_sortable=a.default_no_sortable)}),this.on("afterApplyGroupFlags",function(a,b){b.flags.no_sortable&&b.$el.find(".drag-handle").remove()}),this.on("getGroupTemplate.filter",function(b,c){if(c>1){var d=$(b.value);d.find(Selectors.condition_container).after('<div class="drag-handle"><i class="'+a.icon+'"></i></div>'),b.value=d.prop("outerHTML")}}),this.on("getRuleTemplate.filter",function(b){var c=$(b.value);c.find(Selectors.rule_header).after('<div class="drag-handle"><i class="'+a.icon+'"></i></div>'),b.value=c.prop("outerHTML")})},{default_no_sortable:!1,icon:"glyphicon glyphicon-sort"}),QueryBuilder.defaults({sqlOperators:{equal:{op:"= ?"},not_equal:{op:"!= ?"},"in":{op:"IN(?)",sep:", "},not_in:{op:"NOT IN(?)",sep:", "},less:{op:"< ?"},less_or_equal:{op:"<= ?"},greater:{op:"> ?"},greater_or_equal:{op:">= ?"},between:{op:"BETWEEN ?",sep:" AND "},not_between:{op:"NOT BETWEEN ?",sep:" AND "},begins_with:{op:"LIKE(?)",mod:"{0}%"},not_begins_with:{op:"NOT LIKE(?)",mod:"{0}%"},contains:{op:"LIKE(?)",mod:"%{0}%"},not_contains:{op:"NOT LIKE(?)",mod:"%{0}%"},ends_with:{op:"LIKE(?)",mod:"%{0}"},not_ends_with:{op:"NOT LIKE(?)",mod:"%{0}"},is_empty:{op:"= ''"},is_not_empty:{op:"!= ''"},is_null:{op:"IS NULL"},is_not_null:{op:"IS NOT NULL"}},sqlRuleOperator:{"=":function(a){return{val:a,op:""===a?"is_empty":"equal"}},"!=":function(a){return{val:a,op:""===a?"is_not_empty":"not_equal"}},LIKE:function(a){return"%"==a.slice(0,1)&&"%"==a.slice(-1)?{val:a.slice(1,-1),op:"contains"}:"%"==a.slice(0,1)?{val:a.slice(1),op:"ends_with"}:"%"==a.slice(-1)?{val:a.slice(0,-1),op:"begins_with"}:void Utils.error("SQLParse",'Invalid value for LIKE operator "{0}"',a)},"NOT LIKE":function(a){return"%"==a.slice(0,1)&&"%"==a.slice(-1)?{val:a.slice(1,-1),op:"not_contains"}:"%"==a.slice(0,1)?{val:a.slice(1),op:"not_ends_with"}:"%"==a.slice(-1)?{val:a.slice(0,-1),op:"not_begins_with"}:void Utils.error("SQLParse",'Invalid value for NOT LIKE operator "{0}"',a)},IN:function(a){return{val:a,op:"in"}},"NOT IN":function(a){return{val:a,op:"not_in"}},"<":function(a){return{val:a,op:"less"}},"<=":function(a){return{val:a,op:"less_or_equal"}},">":function(a){return{val:a,op:"greater"}},">=":function(a){return{val:a,op:"greater_or_equal"}},BETWEEN:function(a){return{val:a,op:"between"}},"NOT BETWEEN":function(a){return{val:a,op:"not_between"}},IS:function(a){return null!==a&&Utils.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_null"}},"IS NOT":function(a){return null!==a&&Utils.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_not_null"}}},sqlStatements:{question_mark:function(){var a=[];return{add:function(b,c){return a.push(c),"?"},run:function(){return a}}},numbered:function(a){(!a||a.length>1)&&(a="$");var b=0,c=[];return{add:function(d,e){return c.push(e),b++,a+b},run:function(){return c}}},named:function(a){(!a||a.length>1)&&(a=":");var b={},c={};return{add:function(d,e){b[d.field]||(b[d.field]=1);var f=d.field+"_"+b[d.field]++;return c[f]=e,a+f},run:function(){return c}}}},sqlRuleStatement:{question_mark:function(a){var b=0;return{parse:function(c){return"?"==c?a[b++]:c},esc:function(a){return a.replace(/\?/g,"'?'")}}},numbered:function(a,b){(!b||b.length>1)&&(b="$");var c=new RegExp("^\\"+b+"[0-9]+$"),d=new RegExp("\\"+b+"([0-9]+)","g");return{parse:function(b){return c.test(b)?a[b.slice(1)-1]:b},esc:function(a){return a.replace(d,"'"+("$"==b?"$$":b)+"$1'")}}},named:function(a,b){(!b||b.length>1)&&(b=":");var c=new RegExp("^\\"+b),d=new RegExp("\\"+b+"("+Object.keys(a).join("|")+")","g");return{parse:function(b){return c.test(b)?a[b.slice(1)]:b},esc:function(a){return a.replace(d,"'"+("$"==b?"$$":b)+"$1'")}}}}}),QueryBuilder.extend({getSQL:function(a,b,c){if(c=void 0===c?this.getRules():c,b=b===!0?"\n":" ",a===!0&&(a="question_mark"),"string"==typeof a){var d=getStmtConfig(a);a=this.settings.sqlStatements[d[1]](d[2])}var e=this,f=function g(c){if(c.condition||(c.condition=e.settings.default_condition),["AND","OR"].indexOf(c.condition.toUpperCase())===-1&&Utils.error("UndefinedSQLCondition",'Unable to build SQL query with condition "{0}"',c.condition),!c.rules)return"";var d=[];c.rules.forEach(function(c){if(c.rules&&c.rules.length>0)d.push("("+b+g(c)+b+")"+b);else{var f=e.settings.sqlOperators[c.operator],h=e.getOperatorByType(c.operator),i="";if(void 0===f&&Utils.error("UndefinedSQLOperator",'Unknown SQL operation for operator "{0}"',c.operator),0!==h.nb_inputs){var j=e.change("ruleToSQLValues",c.value,c);j instanceof Array||(j=[j]),j.forEach(function(b,d){d>0&&(i+=f.sep),"integer"==c.type||"double"==c.type||"boolean"==c.type?b=Utils.changeType(b,c.type,!0):a||(b=Utils.escapeString(b)),f.mod&&(b=Utils.fmt(f.mod,b)),a?i+=a.add(c,b):("string"==typeof b&&(b="'"+b+"'"),i+=b)})}var k=function(a){return f.op.replace(/\?/,a)},l=e.change("getSQLField",c.field,c)+" "+k(i);d.push(e.change("ruleToSQL",l,c,i,k))}});var f=d.join(" "+c.condition+b);return e.change("groupToSQL",f,c)}(c);return a?{sql:f,params:a.run()}:{sql:f}},getRulesFromSQL:function(a,b){"SQLParser"in window||Utils.error("MissingLibrary","SQLParser is required to parse SQL queries. Get it here https://github.com/mistic100/sql-parser");var c=this;if("string"==typeof a&&(a={sql:a}),b===!0&&(b="question_mark"),"string"==typeof b){var d=getStmtConfig(b);b=this.settings.sqlRuleStatement[d[1]](a.params,d[2])}b&&(a.sql=b.esc(a.sql)),0!==a.sql.toUpperCase().indexOf("SELECT")&&(a.sql="SELECT * FROM table WHERE "+a.sql);var e=SQLParser.parse(a.sql);if(e.where||Utils.error("SQLParse","No WHERE clause found"),a=c.change("parseSQLNode",e.where.conditions),"rules"in a&&"condition"in a)return a;var f=c.change("sqlToGroup",{condition:this.settings.default_condition,rules:[]},a),g=f;return function h(a,d){if(a=c.change("parseSQLNode",a),"rules"in a&&"condition"in a)return void g.rules.push(a);if("id"in a&&"operator"in a&&"value"in a)return void g.rules.push(a);if("left"in a&&"right"in a&&"operation"in a||Utils.error("SQLParse","Unable to parse WHERE clause"),["AND","OR"].indexOf(a.operation.toUpperCase())!==-1){if(d>0&&g.condition!=a.operation.toUpperCase()){var e=c.change("sqlToGroup",{condition:c.settings.default_condition,rules:[]},a);g.rules.push(e),g=e}g.condition=a.operation.toUpperCase(),d++;var f=g;h(a.left,d),g=f,h(a.right,d)}else{$.isPlainObject(a.right.value)&&Utils.error("SQLParse","Value format not supported for {0}.",a.left.value);var i;i=$.isArray(a.right.value)?a.right.value.map(function(a){return a.value}):a.right.value,b&&(i=$.isArray(i)?i.map(b.parse):b.parse(i));var j=a.operation.toUpperCase();"<>"==j&&(j="!=");var k=c.settings.sqlRuleOperator[j];void 0===k&&Utils.error("UndefinedSQLOperator",'Invalid SQL operation "{0}".',a.operation);var l=k.call(this,i,a.operation),m=a.left.values.join("."),n=c.change("sqlToRule",{id:c.change("getSQLFieldID",m,i),field:m,operator:l.op,value:l.val},a);g.rules.push(n)}}(a,0),f},setRulesFromSQL:function(a,b){this.setRules(this.getRulesFromSQL(a,b))}}),Selectors.subquery_container=".rules-subquery-container",QueryBuilder.types.subquery="subquery",QueryBuilder.define("subquery",function(a){this.status.subquery_id=0,this.on("afterInit",function(a,b){var c=a.builder,d=["equal","not_equal","in","not_in","is_empty","is_not_empty","is_null","is_not_null"];
c.filters.forEach(function(a,b){"subquery"in a&&(c.filters[b].type="subquery",c.filters[b].input=c.createSubquery,c.filters[b].validation={callback:c.validateSubquery},c.filters[b].valueGetter=c.getSubqueryValue,c.filters[b].valueSetter=c.setSubqueryValue)},c);for(var e=0;e<c.operators.length;++e)d.indexOf(c.operators[e].type)!=-1&&c.operators[e].apply_to.push("subquery")}),this.on("afterCreateRuleInput",function(a,b){var c=a.builder;"subquery"==b.filter.type&&c.initSubquery(b)}),this.on("ruleToJson.filter",function(a,b){"subquery"==b.filter.type&&delete a.value.input}),this.on("ruleToSQL.filter",function(a,b,c,d){var e=a.builder;"subquery"==b.type&&(a.value=e.getSubquerySql(a.value,b))}),this.on("ruleToSQLValues.filter",function(a,b){var c=a.builder;"subquery"==b.type&&(a.value=c.getSubquerySqlValues(b))})}),QueryBuilder.extend({nextSubqueryId:function(){return this.status.id+"_subquery_"+this.status.subquery_id++},createSubquery:function(a,b){return"subquery"in a.filter||Utils.error("subquery",'Subquery config missing from "{0}"',a.filter.id),a.subquery_id=this.nextSubqueryId(),'<div id="'+a.subquery_id+'" class="rules-subquery-container"></div>'},initSubquery:function(a){"subquery_id"in a||Utils.error("subquery",'Subquery id missing in "{0}" on initSubquery',a.id),a.$el.addClass("has-subquery");var b=$.extendext(!0,"replace",{},a.filter.subquery),c=$("#"+a.subquery_id);c.attr("data-subquery",a.subquery_id),c.queryBuilder(b)},validateSubquery:function(a,b){"subquery_id"in b||Utils.error("subquery",'Subquery id missing in "{0}" on validateSubquery',b.id);var c=$("#"+b.subquery_id);return!!c.queryBuilder("validate")||["subquery_invalid"]},getSubqueryValue:function(a,b){"subquery_id"in a||Utils.error("subquery",'Subquery id missing in "{0}" on getSubqueryValue',a.id);var c=$("#"+a.subquery_id);b=$.extend({validate:!1},b);var d=c.queryBuilder("getRules",b);return d.subquery_id=a.subquery_id,d},setSubqueryValue:function(a,b){"subquery_id"in a||Utils.error("subquery",'Subquery id missing in "{0}" on setSubqueryValue',a.id);var c=$("#"+a.subquery_id);return c.queryBuilder("setRules",b)},getSubquerySql:function(a,b,c){"subquery_id"in b.value||Utils.error("subquery",'Subquery id missing in "{0}" on getSubquerySql',b.id);var d=$("#"+b.value.subquery_id),e=d.queryBuilder("getSQL","question_mark").sql,f={condition:"AND",rules:[$.extend({},b)]};f.rules[0].type="number",f.rules[0].value=1;var g=this.getSQL("question_mark",!1,f);return g.sql.replace(/\?/," SELECT id FROM "+b.id+" WHERE "+e+" ")},getSubquerySqlValues:function(a){"subquery_id"in a.value||Utils.error("subquery",'Subquery id missing in "{0}" on getSubquerySqlValues',a.id);var b=$("#"+a.value.subquery_id);return b.queryBuilder("getSQL","question_mark").params}}),QueryBuilder.define("unique-filter",function(){this.status.used_filters={},this.on("afterUpdateRuleFilter",this.updateDisabledFilters),this.on("afterDeleteRule",this.updateDisabledFilters),this.on("afterCreateRuleFilters",this.applyDisabledFilters),this.on("afterReset",this.clearDisabledFilters),this.on("afterClear",this.clearDisabledFilters),this.on("getDefaultFilter.filter",function(a,b){var c=a.builder;if(c.updateDisabledFilters(),a.value.id in c.status.used_filters){var d=c.filters.some(function(d){if(!(d.id in c.status.used_filters)||c.status.used_filters[d.id].length>0&&c.status.used_filters[d.id].indexOf(b.parent)===-1)return a.value=d,!0});d||(Utils.error("UniqueFilter","No more non-unique filters available"),a.value=void 0)}})}),QueryBuilder.extend({updateDisabledFilters:function(a){var b=a?a.builder:this;b.status.used_filters={},b.model&&(!function c(a){a.each(function(a){a.filter&&a.filter.unique&&(b.status.used_filters[a.filter.id]||(b.status.used_filters[a.filter.id]=[]),"group"==a.filter.unique&&b.status.used_filters[a.filter.id].push(a.parent))},function(a){c(a)})}(b.model.root),b.applyDisabledFilters(a))},clearDisabledFilters:function(a){var b=a?a.builder:this;b.status.used_filters={},b.applyDisabledFilters(a)},applyDisabledFilters:function(a){var b=a?a.builder:this;b.$el.find(Selectors.filter_container+" option").prop("disabled",!1),$.each(b.status.used_filters,function(a,c){0===c.length?b.$el.find(Selectors.filter_container+' option[value="'+a+'"]:not(:selected)').prop("disabled",!0):c.forEach(function(b){b.each(function(b){b.$el.find(Selectors.filter_container+' option[value="'+a+'"]:not(:selected)').prop("disabled",!0)})})}),b.settings.plugins&&b.settings.plugins["bt-selectpicker"]&&b.$el.find(Selectors.rule_filter).selectpicker("render")}}),QueryBuilder.regional.en={__locale:"English (en)",__author:'Damien "Mistic" Sorel, http://www.strangeplanet.fr',add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",conditions:{AND:"AND",OR:"OR"},operators:{equal:"equal",not_equal:"not equal","in":"in",not_in:"not in",less:"less",less_or_equal:"less or equal",greater:"greater",greater_or_equal:"greater or equal",between:"between",not_between:"not between",begins_with:"begins with",not_begins_with:"doesn't begin with",contains:"contains",not_contains:"doesn't contain",ends_with:"ends with",not_ends_with:"doesn't end with",is_empty:"is empty",is_not_empty:"is not empty",is_null:"is null",is_not_null:"is not null"},errors:{no_filter:"No filter selected",empty_group:"The group is empty",radio_empty:"No value selected",checkbox_empty:"No value selected",select_empty:"No value selected",string_empty:"Empty value",string_exceed_min_length:"Must contain at least {0} characters",string_exceed_max_length:"Must not contain more than {0} characters",string_invalid_format:"Invalid format ({0})",number_nan:"Not a number",number_not_integer:"Not an integer",number_not_double:"Not a real number",number_exceed_min:"Must be greater than {0}",number_exceed_max:"Must be lower than {0}",number_wrong_step:"Must be a multiple of {0}",datetime_empty:"Empty value",datetime_invalid:"Invalid date format ({0})",datetime_exceed_min:"Must be after {0}",datetime_exceed_max:"Must be before {0}",boolean_not_valid:"Not a boolean",operator_not_multiple:"Operator {0} cannot accept multiple values",subquery_invalid:"Error in subquery"},invert:"Invert",NOT:"NOT"},QueryBuilder.defaults({lang_code:"en"});